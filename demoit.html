<h1>Cachez ce Dockerfile que je ne saurais voir</h1>

<img src="/images/00-sad-docker.png"/>

---

<h1>Docker</h1>

<ul>
    <li>Virtualisation légère</li>
    <li>Créer un container à partir d'une image</li>
    <li>Le container va lancer un processus unique</li>
    <li>Le processus sera exécuté avec ses propres librairies système</li>
</ul>

---

<h1>C'est quoi une image ?</h1>

<ul>
    <li>Une succession de calques</li>
    <li>Image de base : une distribution linux comme debian ou alpine</li>
    <li>Chaque calque ajoute du contenu par superposition au précédent</li>
    <li>Chaque calque est immutable</li>
    <li>Les calques ne sont buildés que si nécessaire</li>
</ul>

<img src="/images/02-image-layers.png"/>

---

<h1>Un enjeu de taille</h1>

<ul>
    <li>On veut minimiser la taille de l'image</li>
    <li>Pourquoi :</li>
    <ul>
        <li>Minimiser le temps de transfert lors du déploiement</li>
    </ul>
    <li>Comment :</li>
    <ul>
        <li>Utiliser une image de base "slim" : debian-slim par ex.</li>
        <li>Ne mettre que du contenu utile dans les calques</li>
    </ul>
</ul>

---

<h1>Créer une image #1</h1>

<ul>
    <li>Un fichier descripteur : le Dockerfile</li>
    <li>Instructions simples : FROM, RUN, COPY, ...</li>
    <li>Chaque instruction crée un nouveau calque</li>
</ul>

<img src="/images/09-Dockerfile.png"/>

---

<h1>Créer une image #2</h1>

<ul>
    <li>
        <pre>docker build -t image:tag .</pre>
    </li>
</ul>

<img src="/images/10-docker-build.png"/>

---

<img src="/images/05-stop-dreaming.jpeg"/>

---

<h1>#0 - Démon docker</h1>

<ul>
    <li>Le build passe par le démon docker</li>
    <li>Un démon qui sert à tout : le build et le runtime</li>
    <li>Griefs :</li>
    <ul>
        <li>Un démon qui sert à tout</li>
    </ul>
</ul>

---

<h1>#1 - Démon docker en root</h1>

<ul>
    <li>Le démon docker tourne en root</li>
    <li>Griefs :</li>
    <ul>
        <li>Root inutile pour builder une image</li>
        <li>Root = risque immédiat de sécurité</li>
    </ul>
</ul>

---

<h1>#1 - Démon docker en root</h1>

<img src="/images/20-got-root-access.png"/>

---

<h1>#2 - Contexte de build</h1>

<ul>
    <li>Le contenu du dossier courant est envoyé au démon</li>
    <li>Griefs :</li>
    <ul>
        <li>Transfert pas instantané</li>
        <li>Risque d'envoyer inutilement du contenu</li>
    </ul>
</ul>

---

<h1>#2 - Contexte de build</h1>

<ul>
    <li>Exemple : build d'une application angular</li>
    <li>Seul le dossier dist/ sera dans l'image</li>
</ul>

<img src="/images/30-node_modules-example.png"/>

<p></p>
<video autoplay>
    <source src="/images/send-context.mp4" type="video/mp4">
</video>

---

<h1>#3 - Fichier .dockerignore</h1>

<ul>
    <li>Fonctionnement similaire au .gitignore</li>
    <li>Permets de filtrer le contenu à envoyer au démon docker</li>
    <li>Griefs :</li>
    <ul>
        <li>Attention aux effets de bords</li>
        <li>C'est juste une rustine</li>
    </ul>
</ul>

---

<h1>#4 - Cache des calques</h1>

<ul>
    <li>Chaque instruction du Dockerfile crée un nouveau calque</li>
    <li>Chaque calque est mis en cache et n'est rebuildé que si nécessaire</li>
    <li>Griefs : </li>
    <ul>
        <li>Attention à l'ordre des calques</li>
    </ul>
</ul>

---

<h1>#4 - Cache des calques</h1>

<div class="split" style="margin-top:400px">
    <img src="/images/cache-order-ok.png" width="48%" height="65%"/>
    <img src="/images/cache-order-ko.png" width="48%" height="65%"/>
</div>

---

<h1>#5 - FROM</h1>
<ul>
    <li>basé sur l'héritage uniquement</li>
    <li>"prefer composition over inheritance"</li>
    <li>ex: image de build mvn + npm</li>
    <li>Griefs :</li>
    <ul>
        <li></li>
        <li></li>
    </ul>
</ul>

---

<h1>#6 - RUN</h1>

<ul>
    <li>Éxécute une commande système</li>
    <li>1 RUN = 1 calque</li>
    <li>Griefs :</li>
    <ul>
        <li>Attention aux fichiers supprimés</li>
        <li>La bonne pratique</li>
    </ul>
</ul>

---

<h1>#6 - RUN</h1>

<div class="split" style="margin-top: 300px">
    <img src="/images/RUN-apt-get-clean-ko.png" style=" width:50%; height:50%"/>
</div>

---

<h1>#6 - RUN</h1>

<div class="split" style="margin-top: 300px">
    <img src="/images/RUN-apt-get-clean-ok.png" style=" width:50%; height:50%"/>
</div>

---

<h1>#6 - RUN</h1>

<img src="/images/RUN-good-practise-1.png" />


---

<h1>#6 - RUN</h1>

<img src="/images/RUN-good-practise-2.png" />

---

<h1>#7 - COPY vs ADD</h1>

<ul>
    <li></li>
    <li></li>
    <li></li>
    <li>Griefs :</li>
    <ul>
        <li></li>
        <li></li>
    </ul>
</ul>

---

<h1>#8 - ENTRYPOINT / CMD</h1>
* dualité
* exec form vs json form

<ul>
    <li></li>
    <li></li>
    <li></li>
    <li>Griefs :</li>
    <ul>
        <li></li>
        <li></li>
    </ul>
</ul>

---

<h1>#9 - Multistage build</h1>

<ul>
    <li>...</li>
</ul>

---

<h1>Buildah</h1>

---

<h1>Références</h1>

<ul>
    <li>https://nickjanetakis.com/blog/docker-tip-2-the-difference-between-copy-and-add-in-a-dockerile</li>
    <li>https://openliberty.io/blog/2018/06/29/optimizing-spring-boot-apps-for-docker.html</li>
</ul>
